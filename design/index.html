<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-design" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.0.1">
<title data-rh="true">Design of zkApp for rollup MVP | CML</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://zeko-labs.github.io/zeko/design"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Design of zkApp for rollup MVP | CML"><meta data-rh="true" name="description" content="Basic functionality"><meta data-rh="true" property="og:description" content="Basic functionality"><link data-rh="true" rel="icon" href="/zeko/img/favicon.svg"><link data-rh="true" rel="canonical" href="https://zeko-labs.github.io/zeko/design"><link data-rh="true" rel="alternate" href="https://zeko-labs.github.io/zeko/design" hreflang="en"><link data-rh="true" rel="alternate" href="https://zeko-labs.github.io/zeko/design" hreflang="x-default"><link rel="stylesheet" href="/zeko/assets/css/styles.9d2fee79.css">
<script src="/zeko/assets/js/runtime~main.502cdf62.js" defer="defer"></script>
<script src="/zeko/assets/js/main.667e976c.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zeko/"><div class="navbar__logo"><img src="/zeko/img/favicon.svg" alt="Zeko Labs logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/zeko/img/favicon.svg" alt="Zeko Labs logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Zeko Docs</b></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/zeko/design" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/zeko/">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/zeko/design">Design of zkApp for rollup MVP</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/zeko/da-layer">Zeko data availability contracts</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/zeko/sequencer">Zeko sequencer</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/zeko/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Design of zkApp for rollup MVP</span><meta itemprop="position" content="1"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Design of zkApp for rollup MVP</h1>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="basic-functionality">Basic functionality<a href="#basic-functionality" class="hash-link" aria-label="Direct link to Basic functionality" title="Direct link to Basic functionality">â€‹</a></h2>
<p>Field 0 of the app state is the hash of the current state of the ledger.
The ledger can be updated by providing a transaction statement
and its proof.</p>
<p>We need to support transfers to and from the rollup,
with and without cooperation from the sequencers.</p>
<p>One fundamental constraint is that zkApp commands have a complexity limit,
i.e. you can not have an infinite amount of account updates in a single command
(for obvious reasons).</p>
<p>We also disregard non-Mina tokens for now.</p>
<p>The L1 and L2 are connected by a special account on the L2,
denoted by having the account index 0.</p>
<p>The special account has minimal special treatment.
The transaction snark is modified such that this account
must have a specific vk set,
and the permissions must be all Proof.</p>
<p>The complete state of the account is exposed through requests and responses.</p>
<p>The account must start with the maximum amount of Mina possible when the rollup is made.
When a transfer happens from L1 to L2, an action is added to the L1 account, along with MINA.
The sequencer will also sequence these actions and keep track of a merkle list of
orders and merkle list of processed orders.
These fields will be stored on the L2 account.
On the other end, the L2 account will allow withdrawing MINA if there is such
an unprocessed order, and the processed list field must be updated accordingly.
The L1 account contract will need to check that these match.</p>
<p>In the other direction, MINA can be added to the L2 account along with an action
to go the other way.
On the L1 side this will allow you to withdraw from the account, and update the field
of processed withdrawals at the same time.</p>
<p>Field 0 of the app state of the L2 account is reserved to be the protocol state hash of
the entire L1.</p>
<p>This is implemented by in the zkapp command logic checking whether the account in question
is of the public key in question. The public key in question is fetched through a request.
If it is the specified account then check that the call data of the account update
is equivalent to the call data also fetched via a request.</p>
<p>In essence, we do a cross-layer contract call.</p>
<p>What if we have multiple such account updates in a single L1 rollup update?
The above (almost) inherently limits it to only one, since there is only
one possible call data.
If they both use the same call data, it could happen, but the contract would
be such that is impossible, e.g. by using a counter.</p>
<p>What about if we have none? We run into the problem that &quot;all account updates
for the account&quot; having that call data is <em>vacuously</em> true.
We avoid this by checking that the nonce has been incremented by exactly once,
also avoiding the above problem.</p>
<p>This perhaps isn&#x27;t optimal, since we might run into situations where we want multiple
L2 account updates per &quot;commit&quot; to the L1.</p>
<hr>
<p>Do note that since the L2 has fewer/no limits, it is fast to go from L1 to L2,
but slow to go from L2 to L1, inherently.
The sequencer is also the one expected to do many of the operations on the L2 account,
and will thus also pay those fees, but we will ignore that for now since the fees should
be low enough that it should not deter profit, but we have to think about the incentives
of this.</p>
<hr>
<p>What about all the other conditions on the L2 account? E.g. permissions set to proof and such.
That is part of the <em>initialisation</em>. Currently, initialisation isn&#x27;t
guarded by anything, but before using a rollup, you can check the state of the rollup,
or otherwise check its history, to verify for yourself that it is legitimate.
If it&#x27;s been made illegitimately, you can choose not to use it.
Although we could still enforce proper initialisation in the future if we wanted to.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="implementation">Implementation<a href="#implementation" class="hash-link" aria-label="Direct link to Implementation" title="Direct link to Implementation">â€‹</a></h2>
<p>There are three circuits, one for the nested account, one for the L1 account, and one for merging transaction snarks.
Why another circuit for merging transaction snarks? We ignore first/second-pass logic, since it is not relevant for our
purposes.</p>
<p>The logic for transfers is almost equivalent for the two accounts.
The action state for one account is synchronised to state field 0 of the other account.
State field 1 is the hash of the merkle list of actions processed.
A transfer from L1 to L2 is done by appending an action, adding the necessary amount to the outer account,
then when &quot;sequencing&quot;, we synchronise the fields.
For each such sequencing, there can be exactly one &quot;synchronisation&quot; account update for the nested account,
since the account nonce must be incremented (enforced by the circuit), and that is checked in the outer account&#x27;s
circuit.</p>
<p>At the same time as doing the synchronisation, some amount of payments is done.
For the nested account update, this is likely to be as many as there are to process,
but for the outer one, this is likely to be less, meaning a queue forms.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/zeko/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Introduction</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/zeko/da-layer"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Zeko data availability contracts</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#basic-functionality" class="table-of-contents__link toc-highlight">Basic functionality</a></li><li><a href="#implementation" class="table-of-contents__link toc-highlight">Implementation</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2023 Zeko Labs. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>